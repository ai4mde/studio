from django.shortcuts import render, redirect, get_object_or_404
from shared_models.models import *

{% for page in pages %}
{% for section_component in page.section_components -%}
{% if section_component.has_create_operation %}

def {{ page }}_{{ section_component }}_create(request):
    if request.method == 'POST':
        new_object = {{ section_component.primary_model }}()
        {% for attribute in section_component.attributes -%}
        {% if attribute.type == AttributeType.BOOLEAN -%}
        new_object.{{ attribute }} = (request.POST.get('instance_{{ attribute }}') == 'on')
        {% elif attribute.type == AttributeType.STRING -%}
        if request.POST.get('instance_{{ attribute }}') == '':
            new_object.{{ attribute }} = None
        else:
            new_object.{{ attribute }} = request.POST.get('instance_{{ attribute }}')

        {% elif attribute.type == AttributeType.INTEGER -%}
        if request.POST.get('instance_{{ attribute }}') == '':
            new_object.{{ attribute }} = None
        else: 
            new_object.{{ attribute }} = request.POST.get('instance_{{ attribute }}')
        {% elif attribute.type == AttributeType.FOREIGN_MODEL -%}
        new_object.{{ attribute }} = {{ attribute }}.objects.filter(pk=request.POST.get('instance_{{ attribute }}_id')).first()
        {% endif -%}
        {% endfor -%}
        new_object.save()
    return redirect('render_{{ application_name }}_{{ page }}')

def {{ page }}_{{ section_component }}_create_popup(request):
    context = {}
    {% for model in models_on_pages[page] -%}
    context['{{ model }}_list'] = {{ model }}.objects.all()
    {% endfor -%}
    context['{{ section_component }}_create_popup'] = True
    return render(request, '{{ application_name }}_{{ page }}.html', context)

{% endif -%}

{% if section_component.has_delete_operation %}
def {{ page }}_{{ section_component }}_delete(request, instance_id):
    if request.method == 'POST':
        instance = get_object_or_404({{ section_component.primary_model }}, pk=instance_id)
        instance.delete()
        return redirect('render_{{ application_name }}_{{ page }}')
{% endif -%}

{% if section_component.has_update_operation %}
def {{ page }}_{{ section_component }}_update(request, instance_id):
    if request.method == 'POST':
        instance = get_object_or_404({{ section_component.primary_model }}, pk=instance_id)
        {% for attribute in section_component.updatable_attributes -%}
        {% if attribute.type == AttributeType.BOOLEAN -%}
        instance.{{ attribute }} = (request.POST.get('instance_{{ attribute }}') == 'on')
        {% elif attribute.type == AttributeType.STRING -%}
        instance.{{ attribute }} = request.POST.get('instance_{{ attribute }}')
        {% elif attribute.type == AttributeType.INTEGER -%}
        instance.{{ attribute }} = request.POST.get('instance_{{ attribute }}')
        {% elif attribute.type == AttributeType.FOREIGN_MODEL -%}
        instance.{{ attribute }} = get_object_or_404({{ attribute }}, pk=request.POST.get('instance_{{ attribute }}_id'))
        {% endif -%}
        {% endfor -%}
        instance.save()
        return redirect('render_{{ application_name }}_{{ page }}')


def {{ page }}_{{ section_component }}_update_popup(request, instance_id):
    context = {}
    {% for model in models_on_pages[page] -%}
    context['{{ model }}_list'] = {{ model }}.objects.all()
    {% endfor -%}
    context['update_instance'] = get_object_or_404({{ section_component.primary_model }}, pk=instance_id)
    return render(request, '{{ application_name }}_{{ page }}.html', context)


{% endif -%}
{% endfor %}
{% endfor %}

{% for page in pages %}
def render_{{ application_name }}_{{ page }}(request):
    context = {}
    {% for model in models_on_pages[page] -%}
    context['{{ model }}_list'] = {{ model }}.objects.all()
    {% endfor -%}
    return render(request, '{{ application_name }}_{{ page }}.html', context)
{% endfor %}